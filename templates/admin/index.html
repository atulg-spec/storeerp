{% extends "admin/base_site.html" %}
{% load static %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    body {
        background-color: #f8f9fa;
    }
    a {
        text-decoration: none;
    }
    .stat-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
    }
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
    @media (min-width: 768px) {
        .chart-container {
            height: 350px;
        }
    }
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }
    .badge-status {
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 500;
    }
    .progress-thin {
        height: 8px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block main %}
<div class="container-fluid px-3 px-md-4 py-4">
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold mb-1">Dashboard Overview</h2>
            <p class="text-muted mb-0">
                <i class="bi bi-calendar3"></i> {{ request.user.first_name|default:"Admin" }}, Today is {{ dashboard.today }}
            </p>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="row g-3 g-md-4 mb-4">
        <!-- Total Revenue -->
        <div class="col-6 col-md-3">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between mb-3">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-currency-rupee"></i>
                        </div>
                    </div>
                    <h6 class="text-muted mb-1 small">Total Revenue</h6>
                    <h4 class="fw-bold mb-0">₹{{ dashboard.total_revenue|floatformat:0 }}</h4>
                </div>
            </div>
        </div>
       
        <div class="col-6 col-md-3">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between mb-3">
                        <div class="stat-icon bg-info bg-opacity-10 text-info">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                    </div>
                    <h6 class="text-muted mb-1 small">Total Purchase return</h6>
                    <h4 class="fw-bold mb-0 text-info">₹{{ dashboard.total_purchase_return|floatformat:0 }}</h4>
                </div>
            </div>
        </div>


        <!-- Total Profit
        <div class="col-6 col-md-3">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between mb-3">
                        <div class="stat-icon bg-success bg-opacity-10 text-success">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                    </div>
                    <h6 class="text-muted mb-1 small">Total Profit</h6>
                    <h4 class="fw-bold mb-0 text-success">₹{{ dashboard.total_profit|floatformat:0 }}</h4>
                </div>
            </div>
        </div> -->

        <!-- Stock Value -->
        <div class="col-6 col-md-3">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between mb-3">
                        <div class="stat-icon bg-info bg-opacity-10 text-info">
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                    <h6 class="text-muted mb-1 small">Stock Value</h6>
                    <h4 class="fw-bold mb-0">₹{{ dashboard.total_stock_value|floatformat:0 }}</h4>
                    <small class="text-muted">{{ dashboard.total_items }} items</small>
                </div>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div class="col-6 col-md-3">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between mb-3">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                    </div>
                    <h6 class="text-muted mb-1 small">Low Stock</h6>
                    <h4 class="fw-bold mb-0 text-warning">{{ dashboard.low_stock_count }}</h4>
                    <small class="text-danger">{{ dashboard.out_of_stock }} out of stock</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Overview Row -->
    <div class="row g-3 g-md-4 mb-4">
        <!-- Today's Sales -->
        <div class="col-6 col-lg-3">
            <div class="card stat-card border-0 border-start border-primary border-4">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="text-muted mb-0 small">Today's Sales</h6>
                        <i class="bi bi-calendar-day text-primary"></i>
                    </div>
                    <h5 class="fw-bold mb-1">₹{{ dashboard.today_sales_total|floatformat:0 }}</h5>
                    <small class="text-muted">{{ dashboard.today_sales_count }} transactions</small>
                </div>
            </div>
        </div>

        <!-- This Week -->
        <div class="col-6 col-lg-3">
            <div class="card stat-card border-0 border-start border-success border-4">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="text-muted mb-0 small">This Week</h6>
                        <i class="bi bi-calendar-week text-success"></i>
                    </div>
                    <h5 class="fw-bold mb-1">₹{{ dashboard.week_sales_total|floatformat:0 }}</h5>
                    <small class="text-success">Profit: ₹{{ dashboard.week_sales_profit|floatformat:0 }}</small>
                </div>
            </div>
        </div>

        <!-- This Month -->
        <div class="col-6 col-lg-3">
            <div class="card stat-card border-0 border-start border-info border-4">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="text-muted mb-0 small">This Month</h6>
                        <i class="bi bi-calendar-month text-info"></i>
                    </div>
                    <h5 class="fw-bold mb-1">₹{{ dashboard.month_sales_total|floatformat:0 }}</h5>
                    <small class="text-muted">{{ dashboard.month_sales_count }} sales</small>
                </div>
            </div>
        </div>

        <!-- Unverified Sales -->
        <div class="col-6 col-lg-3">
            <div class="card stat-card border-0 border-start border-warning border-4">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="text-muted mb-0 small">Unverified Sales</h6>
                        <i class="bi bi-hourglass-split text-warning"></i>
                    </div>
                    <h5 class="fw-bold mb-1">{{ dashboard.unverified_sales }}</h5>
                    <small class="text-muted">Awaiting sales</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 g-md-4 mb-4">
        <!-- Daily Sales Chart -->
        <div class="col-12 col-lg-8">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Sales Trends (Last 30 Days)</h5>
                        <span class="badge bg-primary">Daily</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailySalesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Distribution -->
        <div class="col-12 col-lg-4">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <h5 class="fw-bold mb-3">Stock by Category</h5>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Sales & Top Products -->
    <div class="row g-3 g-md-4 mb-4">
        <!-- Monthly Sales Chart -->
        <div class="col-12 col-lg-7">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Monthly Performance</h5>
                        <div>
                            <span class="badge bg-success me-2">Avg Margin: {{ dashboard.avg_profit_margin }}%</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Sales -->
        <div class="col-12 col-lg-5">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Recent Sales</h5>
                        <a href="/sales/sales/" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 text-start">Date</th>
                                    <th class="border-0 text-center">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in dashboard.daily_sales reversed %}
                                <tr>
                                    <td class="text-start text-muted small">{{ sale.date }}</td>
                                    <td class="text-center">₹{{ sale.amount|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">No recent sales</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Recent Sales & Stock Alerts -->
    <div class="row g-3 g-md-4">        
        <!-- Top Products -->
        <div class="col-12 col-lg-6">
            <div class="card stat-card border-0">
                <div class="card-body p-3 p-md-4">
                    <h5 class="fw-bold mb-3">Top Selling Products (This Month)</h5>
                    {% if dashboard.top_products %}
                        <div class="list-group list-group-flush">
                            {% for product in dashboard.top_products %}
                            <div class="list-group-item px-0 border-0 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="flex-grow-1 me-2">
                                        <h6 class="mb-1 fw-semibold">{{ product.stock__name }}</h6>
                                        <small class="text-muted">{{ product.stock__category__name }}</small>
                                    </div>
                                    <span class="badge bg-primary">{{ product.total_sold }} sold</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-success fw-semibold">₹{{ product.revenue|floatformat:0 }}</small>
                                    <div class="progress progress-thin flex-grow-1 ms-3" style="max-width: 100px;">
                                        <div class="progress-bar bg-primary" style="width: {{ product.total_sold|floatformat:0 }}%"></div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No sales data available</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Stock Alerts -->
        <div class="col-12 col-lg-6">
            <div class="card stat-card border-0 border-warning border-top border-3">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Stock Alerts</h5>
                        <a href="/inventory/stock/" class="btn btn-sm btn-outline-warning">Manage</a>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for item in dashboard.stock_alerts %}
                        <div class="list-group-item px-0 border-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-semibold">{{ item.name }}</h6>
                                    <small class="text-muted">{{ item.category.name }}</small>
                                </div>
                                <div class="text-end">
                                    {% if item.quantity == 0 %}
                                        <span class="badge bg-danger">Out of Stock</span>
                                    {% elif item.quantity < 5 %}
                                        <span class="badge bg-warning text-dark">{{ item.quantity }} left</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Low: {{ item.quantity }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center py-4">All stock levels are healthy!</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

    // Daily Sales Chart
    const dailySalesCtx = document.getElementById('dailySalesChart').getContext('2d');
    const dailySalesData = {{ dashboard.daily_sales|safe }};
    
    new Chart(dailySalesCtx, {
        type: 'line',
        data: {
            labels: dailySalesData.map(d => d.date),
            datasets: [{
                label: 'Sales (₹)',
                data: dailySalesData.map(d => d.amount),
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Monthly Sales Chart
    const monthlySalesCtx = document.getElementById('monthlySalesChart').getContext('2d');
    const monthlySalesData = {{ dashboard.monthly_sales|safe }};
    
    new Chart(monthlySalesCtx, {
        type: 'bar',
        data: {
            labels: monthlySalesData.map(d => d.month),
            datasets: [{
                label: 'Revenue (₹)',
                data: monthlySalesData.map(d => d.amount),
                backgroundColor: 'rgba(13, 110, 253, 0.8)',
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Category Distribution Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryData = {{ dashboard.category_distribution|safe }};
    
    const categoryColors = [
        '#0d6efd', '#198754', '#ffc107', '#dc3545', 
        '#6f42c1', '#fd7e14', '#20c997', '#d63384'
    ];
    
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(c => c.category__name),
            datasets: [{
                data: categoryData.map(c => c.total_quantity),
                backgroundColor: categoryColors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' items';
                        }
                    }
                }
            }
        }
    });
})
</script>
{% endblock %}
